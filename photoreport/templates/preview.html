{% extends "base.html" %}
{% load staticfiles i18n %}

{% block title %}Preview{% endblock title %}

{% block css %}
<link href="{% static 'css/preview.css' %}" rel="stylesheet">
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
{% endblock css %}

{% block content %}
<header>
<div class="container" style="padding-top: 50px; padding-bottom: 50px;">
    <div class="row">
        <form action="." method="POST">{% csrf_token %}

    	<div class="col-md-4">
            <ul id="sortable">
            {% for image in images %}
			  <li id="{{image.id}}" onclick="process_image('{{image.image.url}}', '{{image.id}}', 'false')" style="width:80px;height:50px;"><img src="{{image.thumbnail.url}}"></li>
			 {% endfor %}
			</ul>
        </div>

    	<div class="col-md-6 col-md-offset-2" style="position: fixed; right: 0px;">

		<button class="btn btn-warning" style="margin-top: 20px; margin-bottom: 30px;" onclick="update_imgs(this, event)">Hide Uncaptioned Photos</button>
    		{% for image in images %}
        		<div class="form-group">
        			<input id="caption_{{image.id}}" type="text" class="form-control caption hidden" name="caption_{{image.id}}" style="color: black;" placeholder="Write caption for this image ..." {% if image.caption %} value="{{image.caption}}" {% endif %}>
        		</div>
    		{% endfor %}
    		<div class="img-container">
	    		<img id="main-img" src="{{first_img.image.url}}">
    		</div>

                <input type="text" name="project" placeholder="When finished with all captions, Type your Job Number. (i.e. 31010..) and click Save" class="form-control" style="color: black;" {% if project.name %} value="{{project.name}}" {% endif %}>
		<button class="btn btn-success" style="margin-top: 20px;" onclick="$('form').submit();">Finalize / Save</button>


      </div>
    		</form>

    </div>
</div>

</header>
{% endblock content %}

{% block javascript %}

  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <script src="{% static 'js/csrftoken.js' %}"></script>
  <script>
$( document ).ready(function() {
	process_image("{{first_img.image.url}}", "{{first_img.id}}", 'true');

  // check if input fields are cpationed
  $('input[id^="caption_"]').each(function () {
    check_captioned(this);
  });

  // add listener when the user types inside the input fields
  $('input[id^="caption_"]').keyup(function () {
    check_captioned(this);
  });
});

  function update_imgs(btn, e) {
    e.preventDefault();
    var $btn = $(btn);
    if ($btn.hasClass('hidding')) {
      // show all photos
      $btn.removeClass('hidding');
      $('#sortable > li').show();
      $btn.html('Hide Uncaptioned Photos');
    } else {
      // hide uncaptioned photos
      $btn.addClass('hidding');
      $('input[id^="caption_"]').each(function () {
        var value = $(this).val().trim();
        if (value.length == 0) {
          var id = $(this).attr('id').replace('caption_', '');
          $('li#' + id).hide();
        }
      })
      $btn.html('Show Uncaptioned Photos');
    }
  }

  function process_image(img_url, img_id, initial) {
  	if(initial == 'true'){
		  $("#sortable").sortable();
      $("#sortable").disableSelection();
	}else{
		var itemIds = $( "#sortable" ).sortable('toArray');
		post_image_order(itemIds);
	}
  	$('#main-img').attr("src", img_url);
  	$(".caption").removeClass("hidden");
  	$(".caption").not("#caption_" + img_id).hide();
  	$("#caption_" + img_id).show();

  }
function post_image_order(image_order) {
	var url = "/api/project/" + "{{project.id}}/";
	var img_order_str = image_order.join(',');
	data = {image_order: img_order_str};
   $.ajax({
        url: url,
        type: "PUT",
        data: JSON.stringify(data),
        dataType: 'json',
        contentType: "application/json",
        success: function(data) {
        	console.log('success');
        	console.log(data);
        }
    });
}
  function check_captioned(input) {
    var value = $(input).val().trim();
    var id = $(input).attr('id').replace('caption_', '');
    var $img = $('li#' + id).find('img');
    if (value.length > 0) {
      $img.addClass('captioned');
    } else {
      $img.removeClass('captioned');
    }
  }
  </script>
{% endblock javascript %}
